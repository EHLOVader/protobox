- name: mailcatcher | install dependencies
  apt: >
    name={{ item }} 
    state=latest
    force=yes
  with_items:
    - libsqlite3-dev

- name: mailcatcher | install RVM 
  shell: \curl -L https://get.rvm.io | bash -s stable --ruby

- name: mailcatcher | install mailcatcher
  shell: /usr/local/rvm/bin/rvm default@mailcatcher --create do gem install mailcatcher

- name: mailcatcher | install wrapper
  shell: /usr/local/rvm/bin/rvm wrapper default@mailcatcher --no-prefix mailcatcher catchmail

- name: mailcatcher | set facts
  set_fact: >
    mailcatcher_ip="--ip={{ php.mailcatcher.ip|default('0.0.0.0') }}"
    mailcatcher_smtp_port="{{ '--smtp-port=' ~ php.mailcatcher.smtp_port if php.mailcatcher.smtp_port is defined else '' }}"
    mailcatcher_http_port="{{ '--http-port=' ~ php.mailcatcher.http_port if php.mailcatcher.http_port is defined else '' }}"
    mailcatcher_no_quit=""

- name: mailcatcher | create startup script
  template: src=mailcatcher.j2 dest=/etc/init.d/mailcatcher mode=0755

- name: mailcatcher | start on boot
  command: update-rc.d mailcatcher defaults

- name: mailcatcher | not already running 
  command: pkill mailcatcher
  ignore_errors: yes

- name: mailcatcher | start it
  command: /etc/init.d/mailcatcher
