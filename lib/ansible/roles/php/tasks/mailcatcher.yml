- name: mailcatcher | install dependencies
  apt: >
    name={{ item }} 
    state=latest
    force=yes
  with_items:
    - libsqlite3-dev

- name: mailcatcher | install RVM 
  shell: \curl -L https://get.rvm.io | bash -s stable --ruby

- name: mailcatcher | install mailcatcher
  shell: /usr/local/rvm/bin/rvm default@mailcatcher --create do gem install mailcatcher

- name: mailcatcher | install wrapper
  shell: /usr/local/rvm/bin/rvm wrapper default@mailcatcher --no-prefix mailcatcher catchmail

- name: mailcatcher | set facts
  set_fact: >
    mailcatcher_ip="--ip={{ php.mailcatcher.ip|default('0.0.0.0') }}"
    mailcatcher_port="{{ '--smtp-port=' ~ php.mailcatcher.smtp_port if php.mailcatcher.smtp_port is defined else '' }}"
    mailcatcher_http="{{ '--http-port=' ~ php.mailcatcher.http_port if php.mailcatcher.http_port is defined else '' }}"
    mailcatcher_no_quit=""

# service not found:
#- name: mailcatcher | start service
#  service: > 
#    name=mailcatcher
#    state=started
#    arguments="{{ mailcatcher_ip }} {{ mailcatcher_port }} {{ mailcatcher_http }} {{ mailcatcher_no_quit }}"

- name: mailcatcher | start service
  command: > 
    mailcatcher {{ mailcatcher_ip }} {{ mailcatcher_port }} {{ mailcatcher_http }} {{ mailcatcher_no_quit }}
  ignore_errors: True
